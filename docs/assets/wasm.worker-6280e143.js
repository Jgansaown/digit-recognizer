var Q=Object.defineProperty;var X=(r,l,i)=>l in r?Q(r,l,{enumerable:!0,configurable:!0,writable:!0,value:i}):r[l]=i;var g=(r,l,i)=>(X(r,typeof l!="symbol"?l+"":l,i),i);(function(){"use strict";let r;const l=new Array(128).fill(void 0);l.push(void 0,null,!0,!1);function i(n){return l[n]}let h=l.length;function z(n){n<132||(l[n]=h,h=n)}function O(n){const t=i(n);return z(n),t}const R=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&R.decode();let m=null;function y(){return(m===null||m.byteLength===0)&&(m=new Uint8Array(r.memory.buffer)),m}function T(n,t){return n=n>>>0,R.decode(y().subarray(n,n+t))}function a(n){h===l.length&&l.push(l.length+1);const t=h;return h=l[t],l[t]=n,t}function p(n,t){if(!(n instanceof t))throw new Error(`expected instance of ${t.name}`);return n.ptr}let v=null;function q(){return(v===null||v.byteLength===0)&&(v=new Float64Array(r.memory.buffer)),v}let f=0;function S(n,t){const e=t(n.length*8,8)>>>0;return q().set(n,e/8),f=n.length,e}let k=null;function b(){return(k===null||k.byteLength===0)&&(k=new Int32Array(r.memory.buffer)),k}function x(n,t){return n=n>>>0,q().subarray(n/8,n/8+t)}function L(){r.set_panic_hook()}function j(n,t){const e=t(n.length*1,1)>>>0;return y().set(n,e/1),f=n.length,e}const M=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},C=typeof M.encodeInto=="function"?function(n,t){return M.encodeInto(n,t)}:function(n,t){const e=M.encode(n);return t.set(e),{read:n.length,written:e.length}};function D(n,t,e){if(e===void 0){const u=M.encode(n),A=t(u.length,1)>>>0;return y().subarray(A,A+u.length).set(u),f=u.length,A}let o=n.length,s=t(o,1)>>>0;const _=y();let c=0;for(;c<o;c++){const u=n.charCodeAt(c);if(u>127)break;_[s+c]=u}if(c!==o){c!==0&&(n=n.slice(c)),s=e(s,o,o=c+n.length*3,1)>>>0;const u=y().subarray(s+c,s+o),A=C(n,u);c+=A.written}return f=c,s}function d(n,t){try{return n.apply(this,t)}catch(e){r.__wbindgen_exn_store(a(e))}}class w{static __wrap(t){t=t>>>0;const e=Object.create(w.prototype);return e.__wbg_ptr=t,e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();r.__wbg_dataset_free(t)}}class W{static __wrap(t){t=t>>>0;const e=Object.create(W.prototype);return e.__wbg_ptr=t,e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();r.__wbg_kmeans_free(t)}constructor(t,e){const o=r.kmeans_new(t,e);return W.__wrap(o)}step(t){return p(t,w),r.kmeans_step(this.__wbg_ptr,t.__wbg_ptr)}evaluate(t){return p(t,w),r.kmeans_evaluate(this.__wbg_ptr,t.__wbg_ptr)}predict(t){try{const _=r.__wbindgen_add_to_stack_pointer(-16),c=S(t,r.__wbindgen_malloc),u=f;r.kmeans_predict(_,this.__wbg_ptr,c,u);var e=b()[_/4+0],o=b()[_/4+1],s=x(e,o).slice();return r.__wbindgen_free(e,o*8),s}finally{r.__wbindgen_add_to_stack_pointer(16)}}}class E{static __wrap(t){t=t>>>0;const e=Object.create(E.prototype);return e.__wbg_ptr=t,e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();r.__wbg_knearestneighbors_free(t)}constructor(t){const e=r.knearestneighbors_new(t);return E.__wrap(e)}step(t){return p(t,w),r.knearestneighbors_step(this.__wbg_ptr,t.__wbg_ptr)}evaluate(t){return p(t,w),r.knearestneighbors_evaluate(this.__wbg_ptr,t.__wbg_ptr)}predict(t){try{const _=r.__wbindgen_add_to_stack_pointer(-16),c=S(t,r.__wbindgen_malloc),u=f;r.knearestneighbors_predict(_,this.__wbg_ptr,c,u);var e=b()[_/4+0],o=b()[_/4+1],s=x(e,o).slice();return r.__wbindgen_free(e,o*8),s}finally{r.__wbindgen_add_to_stack_pointer(16)}}}class I{__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();r.__wbg_mnist_free(t)}static training_from_static(){const t=r.mnist_training_from_static();return w.__wrap(t)}static testing_from_static(){const t=r.mnist_testing_from_static();return w.__wrap(t)}static training_from_gz(t,e){const o=j(t,r.__wbindgen_malloc),s=f,_=j(e,r.__wbindgen_malloc),c=f,u=r.mnist_training_from_gz(o,s,_,c);return w.__wrap(u)}static testing_from_gz(t,e){const o=j(t,r.__wbindgen_malloc),s=f,_=j(e,r.__wbindgen_malloc),c=f,u=r.mnist_testing_from_gz(o,s,_,c);return w.__wrap(u)}}class F{static __wrap(t){t=t>>>0;const e=Object.create(F.prototype);return e.__wbg_ptr=t,e}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,t}free(){const t=this.__destroy_into_raw();r.__wbg_perceptron_free(t)}constructor(t,e,o){const s=r.perceptron_new(t,e,o);return F.__wrap(s)}step(t){return p(t,w),r.perceptron_step(this.__wbg_ptr,t.__wbg_ptr)}evaluate(t){return p(t,w),r.perceptron_evaluate(this.__wbg_ptr,t.__wbg_ptr)}predict(t){try{const _=r.__wbindgen_add_to_stack_pointer(-16),c=S(t,r.__wbindgen_malloc),u=f;r.perceptron_predict(_,this.__wbg_ptr,c,u);var e=b()[_/4+0],o=b()[_/4+1],s=x(e,o).slice();return r.__wbindgen_free(e,o*8),s}finally{r.__wbindgen_add_to_stack_pointer(16)}}}async function $(n,t){if(typeof Response=="function"&&n instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(n,t)}catch(o){if(n.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const e=await n.arrayBuffer();return await WebAssembly.instantiate(e,t)}else{const e=await WebAssembly.instantiate(n,t);return e instanceof WebAssembly.Instance?{instance:e,module:n}:e}}function N(){const n={};return n.wbg={},n.wbg.__wbg_new_abda76e883ba8a5f=function(){const t=new Error;return a(t)},n.wbg.__wbg_stack_658279fe44541cf6=function(t,e){const o=i(e).stack,s=D(o,r.__wbindgen_malloc,r.__wbindgen_realloc),_=f;b()[t/4+1]=_,b()[t/4+0]=s},n.wbg.__wbg_error_f851667af71bcfc6=function(t,e){let o,s;try{o=t,s=e,console.error(T(t,e))}finally{r.__wbindgen_free(o,s,1)}},n.wbg.__wbindgen_object_drop_ref=function(t){O(t)},n.wbg.__wbg_randomFillSync_dc1e9a60c158336d=function(){return d(function(t,e){i(t).randomFillSync(O(e))},arguments)},n.wbg.__wbg_getRandomValues_37fa2ca9e4e07fab=function(){return d(function(t,e){i(t).getRandomValues(i(e))},arguments)},n.wbg.__wbg_crypto_c48a774b022d20ac=function(t){const e=i(t).crypto;return a(e)},n.wbg.__wbindgen_is_object=function(t){const e=i(t);return typeof e=="object"&&e!==null},n.wbg.__wbg_process_298734cf255a885d=function(t){const e=i(t).process;return a(e)},n.wbg.__wbg_versions_e2e78e134e3e5d01=function(t){const e=i(t).versions;return a(e)},n.wbg.__wbg_node_1cd7a5d853dbea79=function(t){const e=i(t).node;return a(e)},n.wbg.__wbindgen_is_string=function(t){return typeof i(t)=="string"},n.wbg.__wbg_require_8f08ceecec0f4fee=function(){return d(function(){const t=module.require;return a(t)},arguments)},n.wbg.__wbindgen_string_new=function(t,e){const o=T(t,e);return a(o)},n.wbg.__wbg_msCrypto_bcb970640f50a1e8=function(t){const e=i(t).msCrypto;return a(e)},n.wbg.__wbindgen_is_function=function(t){return typeof i(t)=="function"},n.wbg.__wbg_newnoargs_581967eacc0e2604=function(t,e){const o=new Function(T(t,e));return a(o)},n.wbg.__wbg_call_cb65541d95d71282=function(){return d(function(t,e){const o=i(t).call(i(e));return a(o)},arguments)},n.wbg.__wbg_self_1ff1d729e9aae938=function(){return d(function(){const t=self.self;return a(t)},arguments)},n.wbg.__wbg_window_5f4faef6c12b79ec=function(){return d(function(){const t=window.window;return a(t)},arguments)},n.wbg.__wbg_globalThis_1d39714405582d3c=function(){return d(function(){const t=globalThis.globalThis;return a(t)},arguments)},n.wbg.__wbg_global_651f05c6a0944d1c=function(){return d(function(){const t=global.global;return a(t)},arguments)},n.wbg.__wbindgen_is_undefined=function(t){return i(t)===void 0},n.wbg.__wbg_call_01734de55d61e11d=function(){return d(function(t,e,o){const s=i(t).call(i(e),i(o));return a(s)},arguments)},n.wbg.__wbg_buffer_085ec1f694018c4f=function(t){const e=i(t).buffer;return a(e)},n.wbg.__wbg_newwithbyteoffsetandlength_6da8e527659b86aa=function(t,e,o){const s=new Uint8Array(i(t),e>>>0,o>>>0);return a(s)},n.wbg.__wbg_new_8125e318e6245eed=function(t){const e=new Uint8Array(i(t));return a(e)},n.wbg.__wbg_set_5cf90238115182c3=function(t,e,o){i(t).set(i(e),o>>>0)},n.wbg.__wbg_newwithlength_e5d69174d6984cd7=function(t){const e=new Uint8Array(t>>>0);return a(e)},n.wbg.__wbg_subarray_13db269f57aa838d=function(t,e,o){const s=i(t).subarray(e>>>0,o>>>0);return a(s)},n.wbg.__wbindgen_object_clone_ref=function(t){const e=i(t);return a(e)},n.wbg.__wbindgen_throw=function(t,e){throw new Error(T(t,e))},n.wbg.__wbindgen_memory=function(){const t=r.memory;return a(t)},n}function V(n,t){return r=n.exports,U.__wbindgen_wasm_module=t,v=null,k=null,m=null,r}async function U(n){if(r!==void 0)return r;typeof n>"u"&&(n=new URL("/digit-recognizer/assets/mnist_bg-ed10e288.wasm",self.location));const t=N();(typeof n=="string"||typeof Request=="function"&&n instanceof Request||typeof URL=="function"&&n instanceof URL)&&(n=fetch(n));const{instance:e,module:o}=await $(await n,t);return V(e,o)}class B{constructor(t){g(this,"worker");g(this,"count",0);g(this,"resolvers",new Map);g(this,"handlers",{});this.worker=t,this.worker.onmessage=({data:e})=>{e.type=="req"?this.handleReq(e):e.type=="ack"&&this.handleAck(e)}}request(t,e,o){const s=H(this.count,t);return this.count++,this.worker.postMessage({type:"req",id:s,key:t,value:e},{transfer:o}),new Promise((_,c)=>{this.resolvers.has(s)?c(`Duplicate resolver id: ${s}`):this.resolvers.set(s,{res:_,rej:c})})}handle(t,e){this.handlers[t]=e}ack(t,e,o,s){this.worker.postMessage({type:"ack",id:t,key:e,value:o},{transfer:s})}handleReq({id:t,key:e,value:o}){const s=this.handlers[e];if(s!=null){const _=s(o);this.ack(t,e,_.value,_.transfer)}else this.worker.postMessage({type:"ack",id:t,key:e,value:null,err:"handler not set"})}handleAck({id:t,key:e,value:o,err:s}){const _=this.resolvers.get(t);_!==void 0&&(s===void 0?_.res.call(null,o):_.rej.call(null,s),this.resolvers.delete(t))}}function H(...n){return n.map(t=>String(t)).join(".")}function J({type:n,param:t}){switch(n){case"kmeans":return new W(t.n_clusters,28*28);case"knn":return new E(t.k);case"perceptron":return new F(t.learning_rate,28*28,10);default:return}}class P{constructor(){g(this,"pipe",new B(self));g(this,"dataset");g(this,"model");g(this,"timer");g(this,"iteration",0);this.dataset={training:I.training_from_static(),testing:I.testing_from_static()},this.pipe.handle("init_model",t=>(console.log(`[worker][init_model]: ${JSON.stringify(t)}`),{value:this.init_model(t)})),this.pipe.handle("free_model",()=>(console.log("[worker][free_model]"),{value:this.free_model()})),this.pipe.handle("start_training",()=>(console.log("[worker][start_training]"),{value:this.start_training()})),this.pipe.handle("stop_training",()=>(console.log("[worker][stop_training]"),{value:this.stop_training()})),this.pipe.handle("predict",t=>(console.log("[worker][predict]"),this.predict(t))),this.pipe.handle("evaluate",()=>(console.log("[worker][evaluate]"),this.evaluate()))}init_model(t){this.model==null&&(this.model=J(t))}free_model(){this.stop_training(),this.iteration=0,this.model!=null&&(this.model.free(),this.model=void 0)}start_training(){this.timer=setTimeout(this.step.bind(this),0)}stop_training(){clearInterval(this.timer),this.timer=void 0}predict(t){let e=new Float64Array;return this.model&&(e=this.model.predict(t)),{value:e,transfer:[e.buffer]}}evaluate(){let t=NaN;return this.model&&(t=this.model.evaluate(this.dataset.testing)),{value:t}}step(){if(this.model&&this.iteration<=1e6){const t=this.model.step(this.dataset.training);this.iteration++,this.pipe.request("step",{i:this.iteration,err:t}),this.timer=setTimeout(this.step.bind(this),0)}}}async function G(){const n=performance.now();await U();const t=performance.now();return console.log(`wasm init took ${t-n} milliseconds`),L(),new P}G().then(n=>n)})();
